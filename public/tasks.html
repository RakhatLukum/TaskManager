<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manage Tasks - Task Manager</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="logo">Task Manager</div>
    <button class="btn btn-danger" onclick="logout()">Logout</button>
  </header>

  <main>
    <section class="create-task">
      <h2>Create New Task</h2>
      <form id="createTaskForm" class="task-form">
        <label for="createTitle">Title:</label>
        <input type="text" id="createTitle" required />

        <label for="createDescription">Description:</label>
        <input type="text" id="createDescription" />

        <label for="createDueDate">Due Date:</label>
        <input type="date" id="createDueDate" />

        <label for="createTime">Time (HH:MM):</label>
        <input type="text" id="createTime" placeholder="e.g., 10:30" />

        <label for="createStatus">Status:</label>
        <select id="createStatus">
          <option value="not-started">Not Started</option>
          <option value="incomplete">Incomplete</option>
          <option value="finished">Finished</option>
        </select>

        <button type="submit" class="btn btn-primary">Create Task</button>
      </form>
    </section>

    <section class="task-list">
      <h2>Your Tasks</h2>
      <div id="taskList"></div>
    </section>
  </main>

  <!-- Task Edit Section (hidden by default) -->
  <div id="editSection" style="display: none;">
    <h2>Edit Task</h2>
    <form id="editTaskForm">
      <input type="hidden" id="editTaskId" />
      <label>Title:</label><br/>
      <input type="text" id="editTitle" required /><br/>
      <label>Description:</label><br/>
      <input type="text" id="editDescription" /><br/>
      <label>Due Date:</label><br/>
      <input type="date" id="editDueDate" /><br/>
      <label>Time (HH:MM):</label><br/>
      <input type="text" id="editTime" /><br/>
      <label>Status:</label><br/>
      <select id="editStatus">
        <option value="not-started">Not Started</option>
        <option value="incomplete">Incomplete</option>
        <option value="finished">Finished</option>
      </select><br/><br/>
      <button type="submit" class="btn btn-primary">Save Changes</button>
      <button type="button" class="btn btn-secondary" onclick="hideEditSection()">Cancel</button>
    </form>
  </div>

  <script>
    const messageEl = document.getElementById('message');
    const taskListEl = document.getElementById('taskList');
    const token = localStorage.getItem('token');

    // If not logged in, redirect to login
    if (!token) {
      window.location.href = 'login.html';
    }

    // Fetch and display tasks
    async function fetchTasks() {
      try {
        const res = await fetch('/api/tasks', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await res.json();
        if (!res.ok) {
          messageEl.textContent = data.message || 'Could not fetch tasks.';
          return;
        }
        renderTasks(data.tasks);
      } catch (error) {
        console.error(error);
        messageEl.textContent = 'An error occurred while fetching tasks.';
      }
    }

    function renderTasks(tasks) {
      taskListEl.innerHTML = '';
      tasks.forEach(task => {
        const taskDiv = document.createElement('div');
        taskDiv.setAttribute('data-task-id', task._id);
        let dueDateStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'N/A';

        taskDiv.innerHTML = `
          <div class="task-card">
            <div class="task-content">
              <strong>${task.title}</strong>
              <p class="task-description">${task.description}</p>
              <div class="task-due-date">${dueDateStr}</div>
              <div class="task-status ${task.status}">${task.status}</div>
            </div>
            <div class="task-actions">
              <button class="edit-btn" onclick="editTask('${task._id}')">Edit</button>
              <button class="delete-btn" onclick="deleteTask('${task._id}')">Delete</button>
            </div>
          </div>
        `;
        taskListEl.appendChild(taskDiv);
      });
    }

    // Handle task creation
    const createTaskForm = document.getElementById('createTaskForm');
    createTaskForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('createTitle').value;
      const description = document.getElementById('createDescription').value;
      const dueDate = document.getElementById('createDueDate').value;
      const time = document.getElementById('createTime').value;
      const status = document.getElementById('createStatus').value;

      try {
        const res = await fetch('/api/tasks', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ title, description, dueDate, time, status })
        });
        const data = await res.json();
        if (!res.ok) {
          messageEl.textContent = data.message || 'Failed to create task.';
        } else {
          messageEl.textContent = data.message;
          // Clear the form and refresh the task list
          createTaskForm.reset();
          fetchTasks();
        }
      } catch (error) {
        console.error(error);
        messageEl.textContent = 'An error occurred while creating the task.';
      }
    });

    // Edit task functionality
    function editTask(taskId) {
      fetch(`/api/tasks/${taskId}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.task) {
          // Populate the edit form
          document.getElementById('editTaskId').value = data.task._id;
          document.getElementById('editTitle').value = data.task.title;
          document.getElementById('editDescription').value = data.task.description || '';
          document.getElementById('editDueDate').value = data.task.dueDate || '';
          document.getElementById('editTime').value = data.task.time || '';
          document.getElementById('editStatus').value = data.task.status;

          // Show the edit section
          document.getElementById('editSection').style.display = 'block';
        }
      })
      .catch(err => console.error(err));
    }

    function hideEditSection() {
      document.getElementById('editSection').style.display = 'none';
    }

    // Save edited task
    const editTaskForm = document.getElementById('editTaskForm');
    editTaskForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editTaskId').value;
      const title = document.getElementById('editTitle').value;
      const description = document.getElementById('editDescription').value;
      const dueDate = document.getElementById('editDueDate').value;
      const time = document.getElementById('editTime').value;
      const status = document.getElementById('editStatus').value;

      try {
        const res = await fetch(`/api/tasks/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ title, description, dueDate, time, status })
        });
        const data = await res.json();
        if (!res.ok) {
          messageEl.textContent = data.message || 'Failed to update task.';
        } else {
          messageEl.textContent = data.message;
          // Update the task immediately in the list
          updateTaskInList(id, { title, description, dueDate, time, status });
          hideEditSection(); // Hide the edit form after saving
        }
      } catch (error) {
        console.error(error);
        messageEl.textContent = 'An error occurred while updating the task.';
      }
    });

    // Function to update task in the list immediately
    function updateTaskInList(id, updatedTask) {
      const taskDiv = document.querySelector(`[data-task-id='${id}']`);
      if (taskDiv) {
        taskDiv.querySelector('strong').textContent = updatedTask.title;
        taskDiv.querySelector('.task-description').textContent = updatedTask.description;
        taskDiv.querySelector('.task-due-date').textContent = updatedTask.dueDate || 'N/A';
        taskDiv.querySelector('.task-status').textContent = updatedTask.status;
        taskDiv.querySelector('.task-status').className = `task-status ${updatedTask.status}`;
      }
    }

    // Delete task functionality
    function deleteTask(taskId) {
  const isConfirmed = confirm('Are you sure you want to delete this task?');
  if (!isConfirmed) return;

  fetch(`/api/tasks/${taskId}`, {
    method: 'DELETE',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) {
      messageEl.textContent = data.message || 'Failed to delete task.';
    } else {
      messageEl.textContent = data.message;
      // Удаляем задачу с интерфейса без перезагрузки
      const taskDiv = document.querySelector(`[data-task-id='${taskId}']`);
      if (taskDiv) {
        taskDiv.remove();
      }
    }
  })
  .catch(err => {
    console.error(err);
    messageEl.textContent = 'An error occurred while deleting the task.';
  });
}

    // Logout functionality
    function logout() {
      // Remove the token from localStorage
      localStorage.removeItem('token');
      
      // Redirect to the login page
      window.location.href = 'index.html';
    }

    // Fetch tasks on page load
    fetchTasks();
  </script>
</body>
</html>
